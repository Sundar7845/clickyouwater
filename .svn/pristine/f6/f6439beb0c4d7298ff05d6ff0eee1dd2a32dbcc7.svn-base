<?php

namespace App\Traits;

use App\Enums\DocumentModulesType;
use App\Models\AdminSettings;
use App\Models\Area;
use App\Models\BillNoSetting;
use App\Models\City;
use App\Models\Country;
use App\Models\CustomerAddress;
use App\Models\DeliveryPeopleDocuments;
use App\Models\DocumentConfig;
use App\Models\DocumentModules;
use App\Models\EmployeeDocuments;
use App\Models\GeoApiSettings;
use App\Models\HubDocuments;
use App\Models\Log;
use App\Models\LogisticPartnerDocuments;
use App\Models\ManufacturerDocuments;
use App\Models\Menu;
use App\Models\Role;
use App\Models\SmsSettings;
use App\Models\State;
use App\Models\User;
use App\Models\UserRolePermission;
use Carbon\Carbon;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Route;

trait Common
{
    public function getBaseUrl()
    {
        return url('/');
    }
    public function getAdminSetting()
    {
        return AdminSettings::all();
    }
    public function generateOtp($length)
    {
        $min = pow(10, $length - 1);
        $max = pow(10, $length) - 1;
        return rand($min, $max);
    }
    public function generateReferralCode()
    {
        $otpdetails = $this->getOtpDetails();

        $code = substr(md5(uniqid(mt_rand(), true)), 0, $otpdetails->referral_code_length); // generate a random string
        return strtoupper($code);
    }

    public function getSmsDetails()
    {
        return SmsSettings::first();
    }
    public function getOtpDetails()
    {
        return AdminSettings::first();
    }
    public function getMapDetails()
    {
        return GeoApiSettings::first();
    }
    public function createUser($user_name, $email, $password, $ref_id, $display_name, $mobile, $role_id, $is_active, $created_by)
    {
        User::create([
            'user_name' => $user_name,
            'email' => $email,
            'password' => Hash::make($password),
            'ref_id' => $ref_id,
            'display_name' => $display_name,
            'mobile' =>  $mobile,
            'role_id' => $role_id,
            'is_active' => $is_active,
            'created_by' => $created_by
        ]);
    }
    public function updateLiveCount($documentsmodule_id, $plusorminus)
    {
        switch ($documentsmodule_id) {
            case DocumentModulesType::Hub:
                $data = BillNoSetting::first();
                $data->hub_live = ($plusorminus == 1 ? $data->hub_live + 1 : $data->hub_live - 1);
                $data->save();
                break;
            case DocumentModulesType::Employee:
                $data = BillNoSetting::first();
                $data->employee_live  = ($plusorminus == 1 ? $data->employee_live  + 1 : $data->employee_live  - 1);
                $data->save();
                break;
            case DocumentModulesType::Manufacturer:
                $data = BillNoSetting::first();
                $data->manufacture_live  = ($plusorminus == 1 ? $data->manufacture_live  + 1 : $data->manufacture_live  - 1);
                $data->save();
                break;
            case DocumentModulesType::Logistic:
                $data = BillNoSetting::first();
                $data->logistics_live  = ($plusorminus == 1 ? $data->logistics_live  + 1 : $data->logistics_live  - 1);
                $data->save();
                break;
            case DocumentModulesType::DeliveryPerson:
                $data = BillNoSetting::first();
                $data->deliveryperson_live  = ($plusorminus == 1 ? $data->deliveryperson_live  + 1 : $data->deliveryperson_live  - 1);
                $data->save();
                break;
            case DocumentModulesType::Ledger:
                $data = BillNoSetting::first();
                $data->ledger_live = ($plusorminus == 1 ? $data->ledger_live  + 1 : $data->ledger_live  - 1);
                $data->save();
                break;
            case DocumentModulesType::Payment:
                $data = BillNoSetting::first();
                $data->Pay_live = ($plusorminus == 1 ? $data->Pay_live  + 1 : $data->Pay_live  - 1);
                $data->save();
                break;
            default:
                $data = [];
        }
        return $data;
    }

    public function getAutoGeneratedCode($documentsmodule_id)
    {
        $auto_generate_code = null;
        $data = BillNoSetting::first();
        switch ($documentsmodule_id) {
            case DocumentModulesType::Hub:
                $hubPrefix = $data->hub_prefix ?? 0;
                $hubLength = $data->hub_length ?? 0;
                $hubLive = (int)($data->hub_live ?? 0) + 1;
                if ($hubLive) {
                    $hubNumber = $hubLive;
                }
                $hubs = sprintf("%0{$hubLength}d", $hubNumber);
                $hubExample = $hubPrefix . $hubs;

                $auto_generate_code = $hubExample;
                break;

            case DocumentModulesType::Logistic:
                $logPrefix = $data->logistics_prefix ?? 0;
                $logLength = $data->logistics_length ?? 0;
                $logLive = (int)($data->logistics_live ?? 0) + 1;
                if ($logLive) {
                    $logNumber = $logLive;
                }
                $logs = sprintf("%0{$logLength}d", $logNumber);
                $logExample = $logPrefix . $logs;
                $auto_generate_code = $logExample;
                break;

            case DocumentModulesType::Manufacturer:
                $manPrefix = $data->manufacture_prefix ?? 0;
                $ManLength = $data->manufacture_length ?? 0;
                $manLive = (int)($data->manufacture_live ?? 0) + 1;
                if ($manLive) {
                    $manNumber = $manLive;
                }
                $mans = sprintf("%0{$ManLength}d", $manNumber);
                $manExample = $manPrefix . $mans;
                $auto_generate_code = $manExample;
                break;

            case DocumentModulesType::DeliveryPerson:
                $delPrefix = $data->deliveryperson_prefix ?? 0;
                $delLength = $data->deliveryperson_length ?? 0;
                $delLive = (int)($data->deliveryperson_live ?? 0) + 1;
                if ($delLive) {
                    $delNumber = $delLive;
                }
                $del = sprintf("%0{$delLength}d", $delNumber);
                $delExample = $delPrefix . $del;
                $auto_generate_code = $delExample;
                break;

            case DocumentModulesType::Employee:
                $manPrefix = $data->employee_prefix ?? 0;
                $ManLength = $data->employee_length ?? 0;
                $manLive = (int)($data->employee_live ?? 0) + 1;
                if ($manLive) {
                    $manNumber = $manLive;
                }
                $man = sprintf("%0{$ManLength}d", $manNumber);
                $manExample = $manPrefix . $man;
                $auto_generate_code = $manExample;
                break;
            case DocumentModulesType::Payment:
                $payPrefix = $data->Pay_prefix ?? 0;
                $payLength = $data->Pay_length ?? 0;
                $payLive = (int)($data->Pay_live ?? 0) + 1;
                if ($payLive) {
                    $payNumber = $payLive;
                }
                $payment = sprintf("%0{$payLength}d", $payNumber);
                $payExample = $payPrefix . $payment;
                $auto_generate_code = $payExample;
                break;

            case DocumentModulesType::Ledger:
                $ledPrefix = $data->ledger_prefix ?? 0;
                $ledLength = $data->ledger_length ?? 0;
                $ledLive = (int)($data->ledger_live ?? 0) + 1;
                if ($ledLive) {
                    $ledNumber = $ledLive;
                }
                $leds = sprintf("%0{$ledLength}d", $ledNumber);
                $auto_generate_code = $ledPrefix . $leds;
                break;
        }

        return $auto_generate_code;
    }

    public function getCountries()
    {
        return Country::where('is_active', 1)->orderBy('country_name', 'asc')->get(["country_name", "id"]);
    }

    public function getStates($country_id = 1)
    {
        return State::where("country_id", $country_id)->where('is_active', 1)->orderBy('state_name', 'asc')->get(["state_name", "id", "state_code", "is_active"]);
    }

    public function getCities($state_id)
    {
        return City::where("state_id", $state_id)->where('is_active', 1)->orderBy('city_name', 'asc')->get(["city_name", "id"]);
    }

    public function getAreas($city_id)
    {
        return Area::where("city_id", $city_id)->where('is_active', 1)->orderBy('area_name', 'asc')->get(['area_name', 'id']);
    }
    public function getCustomerAddress_details($id = Null)
    {
        if ($id != null) {
            return CustomerAddress::with('getAddressType', 'cityname', 'statename', 'countryname')
                ->where("customer_id", Auth::user()->customer->id)
                ->where("id", $id)
                ->get();
        } else {
            return CustomerAddress::with('getAddressType', 'cityname', 'statename', 'countryname')
                ->where("customer_id", Auth::user()->customer->id)->get();
        }
    }

    public function checkUserPermission($user_id)
    {
        $userPermission = UserRolePermission::select('menu_id')->where('user_id', $user_id)->get()->toArray();
        $getMenuId = explode(',', $userPermission['menu_id'] ?? 0);
        $checkpermission = Menu::whereIn('id', [$getMenuId])->first();
        if ($checkpermission) {
            return true;
        } else {
            return false;
        }
    }

    public function fileUpload($fileinput, $filepath, $fileName)
    {
        $fileinput->move(public_path($filepath), $fileName);
        return $filepath . '/' . $fileName;
    }

    public function generateRandom($digit)
    {
        // switch ($digit) {
        //     case 8:
        //         return mt_rand(10000000, 99999999);
        //     case 4:
        //         return mt_rand(1000, 9999);
        //     case 16:
        //         return mt_rand(1000000000000000, 9999999999999999);
        //     default:
        //         return mt_rand(100000, 999999);
        // }
        // $digit = $digit + 1;
        $min = pow(10, $digit - 1);
        $max = pow(10, $digit) - 1;
        return rand($min, $max);
    }

    public function getRolesForDropDown()
    {
        $role_id = [1, 3, 4, 5, 6, 17, 18];
        $roles = Role::whereNotIn('id', $role_id)->whereNull('deleted_at')->get();

        return $roles;
    }

    public function getUserRolesForDropDown()
    {
        $role_id = [1, 3, 4, 5, 6, 17, 18];
        $users = User::where('is_active', 1)->whereNotIn('role_id', $role_id)->get();

        return $users;
    }

    public function validateDocuments($request, $documentsmodule_id)
    {
        $documents = $this->getDocumentsByModule($documentsmodule_id);
        foreach ($documents as $item) {
            if ($item->is_mandatory == 1) {
                $document = 'doc_' . $item->id;
                $image = 'file_' . $item->id;
                if ($request->$document == null || $request->$image == null) {
                    return $item;
                }
            }
        }
        return true;
    }

    public function validateUpdateDocuments($request, $documentsmodule_id, $id)
    {
        $documents = $this->getDocumentConfigsByModule($documentsmodule_id, $id);
        foreach ($documents as $item) {
            if ($item->is_mandatory == 1) {
                $existingimage = 'hdDocumentImg_' . $item->id;
                $document = 'doc_' . $item->id;
                $image = 'file_' . $item->id;
                if ($request->$document == null || ($request->$existingimage == null ? $request->$image : $request->$existingimage) == null) {
                    return $item;
                }
            }
        }
        return true;
    }

    public function getDocumentsByModule($documentsmodule_id)
    {
        $documents = DocumentConfig::join('document_modules', 'document_modules.id', 'document_configs.documentmodule_id')
            ->join('document_types', 'document_types.id', 'document_configs.documenttype_id')
            ->where('documentmodule_id', $documentsmodule_id)->where('document_configs.is_active', 1)
            ->select('document_configs.*', 'document_modules.module_name', 'document_types.documenttype_name')
            ->get();

        return $documents;
    }
    public function getDocumentConfigsByModule($documentsmodule_id, $id)
    {
        $documents = [];
        switch ($documentsmodule_id) {
            case DocumentModulesType::Hub:
                $documents = DocumentConfig::with('documentType', 'documentModule')
                    ->where('document_configs.documentmodule_id', $documentsmodule_id)
                    ->leftJoin('hub_documents as hd', function ($join) use ($id) {
                        $join->on('hd.documenttype_id', 'document_configs.documenttype_id')
                            ->where('hd.hub_id', $id);
                    })
                    ->where('document_configs.documentmodule_id', $documentsmodule_id)
                    ->where('document_configs.is_active', 1)
                    ->select('document_configs.*', 'hd.hub_id', 'hd.document_number', 'hd.document_path')
                    ->get();
                break;
            case DocumentModulesType::Employee:
                $documents = DocumentConfig::with('documentType', 'documentModule')
                    ->leftJoin('employee_documents as ed', function ($join) use ($id) {
                        $join->on('ed.documenttype_id', 'document_configs.documenttype_id')
                            ->where('ed.employee_id', $id);
                    })
                    ->where('document_configs.documentmodule_id', $documentsmodule_id)
                    ->where('document_configs.is_active', 1)
                    ->select('document_configs.*', 'ed.employee_id', 'ed.document_number', 'ed.document_path')
                    ->get();

                break;
            case DocumentModulesType::Manufacturer:
                $documents = DocumentConfig::with('documentType', 'documentModule')
                    ->leftJoin('manufacturer_documents as md', function ($join) use ($id) {
                        $join->on('md.documenttype_id', 'document_configs.documenttype_id')
                            ->where('md.manufacture_id', $id);
                    })
                    ->where('document_configs.documentmodule_id', $documentsmodule_id)
                    ->where('document_configs.is_active', 1)
                    ->select('document_configs.*', 'md.manufacture_id', 'md.document_number', 'md.document_path')
                    ->get();

                break;
            case DocumentModulesType::Logistic:
                $documents = DocumentConfig::with('documentType', 'documentModule')
                    ->leftJoin('logistic_partner_documents as lpd', function ($join) use ($id) {
                        $join->on('lpd.documenttype_id', 'document_configs.documenttype_id')
                            ->where('lpd.logistic_partner_id', $id);
                    })
                    ->where('document_configs.documentmodule_id', $documentsmodule_id)
                    ->where('document_configs.is_active', 1)
                    ->select('document_configs.*', 'lpd.logistic_partner_id', 'lpd.document_number', 'lpd.document_path')
                    ->get();
                break;
            case DocumentModulesType::DeliveryPerson:
                $documents = DocumentConfig::with('documentType', 'documentModule')
                    ->leftJoin('delivery_people_documents as dpd', function ($join) use ($id) {
                        $join->on('dpd.documenttype_id', 'document_configs.documenttype_id')
                            ->where('dpd.delivery_people_id', $id);
                    })
                    ->where('document_configs.documentmodule_id', $documentsmodule_id)
                    ->where('document_configs.is_active', 1)
                    ->select('document_configs.*', 'dpd.delivery_people_id', 'dpd.document_number', 'dpd.document_path')
                    ->get();
                break;
            default:
                $documents = [];
        }
        return $documents;
    }

    public function Log($transaction_name, $mode, $log_message, $user_id, $ip_address, $system_name, $is_app = 0)
    {
        Log::create([
            'transaction_name' => $transaction_name,
            'mode' => $mode,
            'log_message' => $log_message,
            'user_id' => $user_id,
            'ip_address' => $ip_address,
            'system_name' =>  $system_name,
            'is_app' =>  $is_app,
            'log_date' => Carbon::now()
        ]);
    }

    public function chkUserFilePermission()
    {
        $currentRouteName = Route::currentRouteName();
        $menu = Menu::where('menu_url', '/' . $currentRouteName)->first();
        if ($menu) {
            $chkUserFilePermission = UserRolePermission::select('is_edit', 'is_delete', 'is_view', 'is_print', 'is_approval')->where('user_id', Auth::user()->id)
                ->where('menu_id', $menu->id)
                ->first();
            return $chkUserFilePermission;
        }
    }

    public function documentTitle($documentsmodule_id)
    {
        $documentTitle = [];
        switch ($documentsmodule_id) {
            case DocumentModulesType::DeliveryPerson:
                $documentTitle = DocumentModules::where('id', $documentsmodule_id)->pluck('module_name')->first();
                break;
            case DocumentModulesType::Employee:
                $documentTitle = DocumentModules::where('id', $documentsmodule_id)->pluck('module_name')->first();
                break;
            case DocumentModulesType::Manufacturer:
                $documentTitle = DocumentModules::where('id', $documentsmodule_id)->pluck('module_name')->first();
                break;
            case DocumentModulesType::Logistic:
                $documentTitle = DocumentModules::where('id', $documentsmodule_id)->pluck('module_name')->first();
                break;
            case DocumentModulesType::Hub:
                $documentTitle = DocumentModules::where('id', $documentsmodule_id)->pluck('module_name')->first();
                break;
            default:
                $documentTitle = [];
        }
        return $documentTitle;
    }

    public function documentByUsers($documentsmodule_id, $id)
    {
        $documents = [];
        switch ($documentsmodule_id) {
            case DocumentModulesType::DeliveryPerson:
                $documents = DeliveryPeopleDocuments::with('documentType')
                    ->where('delivery_people_documents.delivery_people_id', $id)
                    ->get();
                break;
            case DocumentModulesType::Logistic:
                $documents = LogisticPartnerDocuments::with('documentType')
                    ->where('logistic_partner_documents.logistic_partner_id', $id)
                    ->get();
                break;
            case DocumentModulesType::Manufacturer:
                $documents = ManufacturerDocuments::with('documentType')
                    ->where('manufacturer_documents.manufacture_id', $id)
                    ->get();
                break;
            case DocumentModulesType::Hub:
                $documents = HubDocuments::with('documentType')
                    ->where('hub_documents.hub_id', $id)
                    ->get();
                break;
            case DocumentModulesType::Employee:
                $documents = EmployeeDocuments::with('documentType')
                    ->where('employee_documents.employee_id', $id)
                    ->get();
                break;
            default:
                $documents = [];
        }
        return $documents;
    }

    public function updateDocumentVerification($documentsmodule_id, $id, $status)
    {
        $documents = [];
        switch ($documentsmodule_id) {
            case DocumentModulesType::Logistic:
                LogisticPartnerDocuments::findorfail($id)->update([
                    'is_verified' => $status,
                    'updated_by' => Auth::user()->id
                ]);
                break;
            case DocumentModulesType::DeliveryPerson:
                DeliveryPeopleDocuments::findorfail($id)->update([
                    'is_verified' => $status,
                    'updated_by' => Auth::user()->id
                ]);
                break;
            case DocumentModulesType::Manufacturer:
                ManufacturerDocuments::findorfail($id)->update([
                    'is_verified' => $status,
                    'updated_by' => Auth::user()->id
                ]);
                break;
            case DocumentModulesType::Hub:
                HubDocuments::findorfail($id)->update([
                    'is_verified' => $status,
                    'updated_by' => Auth::user()->id
                ]);
                break;
            case DocumentModulesType::Employee:
                EmployeeDocuments::findorfail($id)->update([
                    'is_verified' => $status,
                    'updated_by' => Auth::user()->id
                ]);
                break;
            default:
                $documents = [];
        }
        return $documents;
    }

    public function getOrCreateAreaId($areaName, $stateId, $cityId)
    {
        $area = Area::where('area_name', $areaName)
            ->orWhere('id', $areaName)
            ->where('state_id', $stateId)
            ->where('city_id', $cityId)
            ->first();

        if ($area) {
            return $area->id;
        } else {
            $newArea = new Area;
            $newArea->area_name = $areaName;
            $newArea->state_id = $stateId;
            $newArea->city_id = $cityId;
            $newArea->created_by = Auth::user()->id;
            $newArea->created_at = Carbon::now();
            $newArea->save();

            return $newArea->id;
        }
    }

}
